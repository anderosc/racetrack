<!DOCTYPE html>
<html>
<head>
  <title>Race Control</title>
  <link   rel="stylesheet">
</head>
<body>

  <!-- login
   TODO, shows the page before actually logged in hehe
    -->
  <div id="loginScreen">
    <h2>Safety Official Login</h2>
    <input type="password" id="accessKey" placeholder="Enter access key">
    <button id="loginBtn">Login</button>
    <p id="loginErr" style="color:red; display:none;">Incorrect key</p>
  </div>


  <div id="raceControl">
    <h1>Race Control</h1>
    
    <div id="current-session">
      <h2>Current Session</h2>
      <div id="raceTimer">Timer: --:--</div>
    </div>

    <div id="controls">
      <button id="startRaceBtn">Start Race</button>
      <button id="safe" >Safe</button>
      <button id="hazard" >Hazard</button>
      <button id="danger" >Danger</button>
      <button id="finish"  >Finish</button>
      <button id="endSessionBtn">End Session</button>
    </div>
    <br>
    <br>
    <div>
      <div id="currentDrivers"></div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const loginScreen = document.getElementById("loginScreen");
    const uiScreen = document.getElementById("raceControl");
    const loginBtn = document.getElementById("loginBtn");
    const keyInput = document.getElementById("accessKey");
    const loginError = document.getElementById("loginErr");

    const startRaceBtn = document.getElementById("startRaceBtn");
    const endSessionBtn = document.getElementById("endSessionBtn");
    const safeBtn = document.getElementById("safe");
    const hazardBtn = document.getElementById("hazard");
    const dangerBtn = document.getElementById("danger");
    const finishBtn = document.getElementById("finish");


    const raceTimer = document.getElementById("raceTimer");
    const currentDrivers = document.getElementById("currentDrivers");

    let timerInterval = null; 
    let raceSeconds = 0;

    // let data = {}

    loginBtn.addEventListener("click", () => {
        socket.emit("login", { persona: "RaceControl", token: keyInput.value });
    });

    socket.on("race:init", (state) => {
      console.log(state);
      renderDrivers(state)
    })

    socket.on("login", (res) => {
        if (res.status) {
            loginScreen.style.display = "none";
            uiScreen.style.display = "block";
            loginError.style.display = "none";
            // socket.emit("raceControl:ready");
        } else {
            return
          socket.on("race:update", (state) => {
          renderDrivers(state)
          });
        }
    });

  function renderDrivers(state){
    console.log(state)
    console.log("works")
    if(!state.currentRace?.sessionName){
      return;
    }
    console.log("works")

    if (state.currentRace.drivers) {
      currentDrivers.innerHTML = state.currentRace.drivers
      .map(driver => `<div>${driver.name} (Car ${driver.car})</div>`)
    }
    console.log("works")

  }
// Start race
  startRaceBtn.addEventListener("click", () => {

      console.log(state.currentRace)
     const race = state.currentRace;
    if (!race) {
      return
    };


    // update timer inital value if it started
    if (race.durationSeconds !== undefined) {
        raceSeconds = race.durationSeconds;

        
        if (!timerInterval) {
            timerInterval = setInterval(() => {
                if (raceSeconds > 0) {
                    raceSeconds--;
                    raceTimer.innerHTML = `Timer: ${formatTime(raceSeconds)}`;
                } else {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
            }, 1000);
    socket.emit("race:start", state);
        }
    }
  })



// Change race mode
  safeBtn.addEventListener("click", () => {
    socket.emit("race:safe");
  });
  hazardBtn.addEventListener("click", () => {
    socket.emit("race:hazard");
  });    
  dangerBtn.addEventListener("click", () => {
    socket.emit("race:danger");
  });

// End session
    endSessionBtn.addEventListener("click", (state) => {
        socket.emit("race:endSession", state);
        clearInterval(timerInterval);
        raceTimer.innerHTML = "Timer: --:--"
        renderDrivers(state);
    });

// Finish session
    finishBtn.addEventListener("click", () => {
        socket.emit("race:finish");
    });

// Update drivers when state changes and map them to DOM
    socket.on("state:update", (state) => {

    });

        

    

    //remaining time from socket to seconds
    function formatTime(seconds) {
        let m = Math.floor(seconds / 60);
        let s = seconds % 60;
        if (m < 10) {
            m = '0' + m;
        }
        if (s < 10) {
            s = '0' + s;
        }
        return m + ':' + s;
    }

  </script>
</body>
</html>
