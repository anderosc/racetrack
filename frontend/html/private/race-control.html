<!DOCTYPE html>
<html>
<head>
  <title>Race Control</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="/css/public/main.css">
  <link rel="stylesheet" type="text/css" href="/css/private/race-control.css">
</head>
<body>

  <!-- login
   TODO, shows the page before actually logged in hehe
    -->
   <!-- <div id="loginScreen">
    <h2>Safety Official Login</h2>
    <input type="password" id="accessKey" placeholder="Enter access key">
    <button id="loginBtn">Login</button>
    <p id="loginErr" style="color:red; display:none;">Incorrect key</p>
  </div>-->
  <div id="navbar" class="left">
    <div class="button" style="height: 40px;"><p style="font-size: 14px;">< Hide NavBar</p></div></a>
    <a href="/front-desk"><div class="button"><p>Front Desk</p></div></a>
    <a href="/race-control"><div class="button"><p>Race Control</p></div></a>
      <a href="/lap-line-tracker"><div class="button"><p>Lap-line Tracker</p></div></a>
      <a href="/leader-board"><div class="button"><p>Leader Board</p></div></a>
      <a href="/next-race"><div class="button"><p>Next Race</p></div></a>
      <a href="/race-countdown"><div class="button"><p>Race Countdown</p></div></a>
      <a href="/race-flags"><div class="button"><p>Race Flag</p></div></a>
  </div>
  <div id="content" class="right">
      <div id="showNavBarBtn" class="showNavBar">
          <div class="navBarBox"></div>
          <div class="navBarBox"></div>
          <div class="navBarBox"></div>
      </div>
      <div id="loginScreen" class="loginbox centerDiv">
          <label for="token"><p>Enter Race Control Key</p></label>
          <input type="password" placeholder="Enter Race Control Key" id="accessKey"></input>
          <button id="loginBtn" class="loginbtn" type="submit"><p>Login</p></button>
          <div id="loginErr" class="loginerror"><p>Login Failed, please try again.</p></div>
      </div>
  <div id="raceControl" style="display:none;">
    <div class="content-box">
      <p>Race Control</p>
      <div id="logout" class="logout">
          <p>Logout</p>
      </div>
    </div>
    <div id="current-session">
      <h2 id="session">Current Session </h2>
      <div id="raceTimer">Timer :<div id="minutes"> 0 </div> <div id="minutes"> 0 </div></div>
    </div>
    <div id="controls">
      <div> 
        <button id="startRaceBtn">Start Race</button>
      </div>
      <div id="raceControls">
        <button id="safe" >Safe</button>
        <button id="hazard" >Hazard</button>
        <button id="danger" >Danger</button>
        <button id="finish"  >Finish</button>
      </div>
      <div>
        <button id="endSessionBtn">End Session</button>
      </div>
    </div>
    <br>
    <br>
    <div>
      <div id="currentDrivers"></div>
    </div>
    <p id="err" style="color:red; display:none;"></p>
  </div>
</div>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/public/navBarToggle.js"></script>
  <script>
    const socket = io();

    const loginScreen = document.getElementById("loginScreen");
    const uiScreen = document.getElementById("raceControl");
    const loginBtn = document.getElementById("loginBtn");
    const keyInput = document.getElementById("accessKey");
    const loginErr = document.getElementById("loginErr")
    const errTag = document.getElementById("err");

    const initRace = document.getElementById("initRace");
    const startRaceBtn = document.getElementById("startRaceBtn");
    const endSessionBtn = document.getElementById("endSessionBtn");
    const session = document.getElementById("session");
    const safeBtn = document.getElementById("safe");
    const hazardBtn = document.getElementById("hazard");
    const dangerBtn = document.getElementById("danger");
    const finishBtn = document.getElementById("finish");

    const raceControls = document.getElementById("raceControls");

    const raceTimer = document.getElementById("raceTimer");
    const currentDrivers = document.getElementById("currentDrivers");

    document.getElementById("logout").addEventListener("click", logout);

    let timerInterval = null; 
    let raceSeconds = 0;

    function logout() {
      document.cookie = "raceControl_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC;";
      location.reload();
    }

    // let data = {}
// Listen serverist tulevat state'i
function renderRaceState(state) {

  console.log("Got state from server:", state);

  // Check if there is ongoing race and start it again
  if (state.currentRace?.isStarted && state.currentRace.durationSeconds > 0) {
    startRaceBtn.style.display = "none";
    raceControls.style.display = "block";
    endSessionBtn.style.display = "none";
    errTag.style.display = "none"
    session.style.display = "block"
    session.innerHTML = `Current session :` + state.currentRace.sessionName
     if (!timerInterval) {
            timerInterval = setInterval(() => {
                if (state.currentRace.durationSeconds > 0) {
                    state.currentRace.durationSeconds--;
                    raceTimer.innerHTML = `Timer : ${formatTime(state.currentRace.durationSeconds)}`;
                } else {
                    clearInterval(timerInterval);
                    timerInterval = null;
                      socket.emit("race:finish");
                      clearInterval(timerInterval);
                      endSessionBtn.style.display = "block"
                      raceControls.style.display = "none"
                }
                // console.log("this is the state" , state)
            }, 1000);
        }
      return
  } else if (state.currentRace?.raceMode === "Finish") {

    startRaceBtn.style.display = "none"; 
    raceControls.style.display = "none";
    endSessionBtn.style.display = "block";
    errTag.style.display = "none"
    session.style.display = "block"
    session.innerHTML = `Current session :` + state.currentRace.sessionName
    return
  } else if (state.currentRace?.raceMode === "Danger" && state.currentRace?.isEnded == true  ) {

      if(state.upComingRaces.length == 0 || state.upComingRaces == null){
        startRaceBtn.style.display = "none";
        raceControls.style.display = "none";
        endSessionBtn.style.display = "none";
        session.style.display = "none"

        errTag.innerHTML ="No upcoming races"
        errTag.style.display = "block"
          return
      } else { 

        startRaceBtn.style.display = "block";
        session.style.display = "none"

        raceControls.style.display = "none";
        endSessionBtn.style.display = "none";
        errTag.style.display = "none"
        return
    }
  } else{
    startRaceBtn.style.display = "block"
    raceControls.style.display = "none";
    endSessionBtn.style.display = "none";
    errTag.style.display = "none"
    return
  }


}

socket.on("race:update", renderRaceState);


// Login click
loginBtn.addEventListener("click", () => {
  if (keyInput.value) {
    socket.emit("login", { persona: "raceControl", token: keyInput.value });
  }
});

socket.on("login", (res) => {

  const persona = res.persona;
  const status = res.status;
    if(persona == "raceControl") {
      if (status) {
        if(res.cookie != true) {
          document.cookie = "raceControl_token=" +  keyInput.value + "; path=/";
        }
        loginScreen.style.display = "none";
        uiScreen.style.display = "block";
        loginErr.style.display = "none";

        // Emit init after loginit
        socket.emit("race:init");
      } else {
        loginErr.style.display = "block";
        keyInput.value = "";
      }
  }
});



// Start race
  startRaceBtn.addEventListener("click", () => {
    socket.emit("race:start");
});


    
// update timer inital value if it started

// Change race mode
  safeBtn.addEventListener("click", () => {
    socket.emit("race:safe");
  });
  hazardBtn.addEventListener("click", () => {
    socket.emit("race:hazard");
  });    
  dangerBtn.addEventListener("click", () => {
    socket.emit("race:danger");
  });

// End session

  endSessionBtn.addEventListener("click", (state) => {
    socket.emit("race:endSession", state);
    clearInterval(timerInterval);
    raceTimer.innerHTML = `Timer : <div id="minutes"> ` + 0 +` </div>`  + ':' + `<div id="minutes"> ` + 0 +` </div>`
    socket.emit("race:init")

    // renderDrivers(state);
  });

// Finish session
    finishBtn.addEventListener("click", () => {
        socket.emit("race:finish");
        clearInterval(timerInterval);
        endSessionBtn.style.display = "block"
        raceControls.style.display = "none"
        timerInterval = null
    });

  socket.on("racecontrol:error", (errorMessage) =>{
    startRaceBtn.style.display = "none";
    raceControls.style.display = "none";
    endSessionBtn.style.display = "none";
    session.style.display = "none"
    errTag.innerHTML = errorMessage.message + ":" + errorMessage.error
    errTag.style.display = "block"
  })
    

    //remaining time from socket to seconds
  function formatTime(seconds) {
    let m = Math.floor(seconds / 60);
    let s = seconds % 60;
    if (m < 10) {
      m = '0' + m;
    }
    if (s < 10) {
      s = '0' + s;
    }
    //return divs with minutes and seconds 
      return ` <div id="minutes"> ` +m +` </div>`  + ':' + `<div id="minutes"> ` + s +` </div>`;
  }

  </script>
</body>
</html>
